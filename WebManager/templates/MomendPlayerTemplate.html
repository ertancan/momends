{% load url from future %}

<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %} Momends {% endblock title %}</title>

    {% block include %}
        <link href="{{ STATIC_URL }}fonts/font-awesome/font-awesome.css" rel="stylesheet">
        <!--[if IE 7]>
		    <link href={{ STATIC_URL }}fonts/font-awesome/font-awesome-ie7.css" rel="stylesheet">
	    <![endif]-->
        <script src="{{ STATIC_URL }}jquery.js"></script>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
        <link href="{{ STATIC_URL }}momend_style.css" rel="stylesheet" type="text/css" />
        <link href="{{ STATIC_URL }}player_style.css" rel="stylesheet" type="text/css" />
        <script>STATIC_URL = '{{ STATIC_URL }}';  </script>
        <script>MOMEND_FILE_URL = '{{ MOMEND_FILE_URL }}';  </script>
        <script>THEME_DATA_URL = '{{ THEME_DATA_URL }}';  </script>
    {% endblock include %}
</head>

<body>
{% block heading %} {% endblock heading %}
{% block content %}
    <body onload="playerInit()">
    <div class="player">
        <div class="scene" id="scene"></div>
        <div class="music"></div>
        <div class="momend-player">
            <div class="momend-button-group">
                <button id="play-toggle" class="icon-pause player-button"></button>
                <div id="volume-slider"></div>
            </div>
            <div class="momend-button-group right-group">
                <button class="icon-heart player-button" id="button-like" href="#"></button>
                <button class="icon-share player-button" id="button-share" href="#"></button>
                <button class="icon-fullscreen player-button" href="#" id="button-fullscreen"></button>
            </div>
        </div>
    </div>
    <div class="finished-modal-bg" id="finished-bg" style="display: none;">
        <div class="finished-modal" id="finished-modal">
            <div id="send-interaction-button" onclick="sendInteractionData()" class="finished-modal-button">
                <i class="icon-magic modal-icon" id="send-interaction-icon"></i>
                <span id="send-interaction-text">Save Interaction</span>
            </div>
            <div id="final-share-button" onclick="share()" class="finished-modal-button">
                <i class="icon-share modal-icon" id="share-button-icon"></i>
                <span>Share</span>
            </div>
        </div>
    </div>
    <div class="loading-bg" id="loading-bg">
        <i class="icon-refresh icon-spin icon-3x"></i>
        <br>
        <b class="loading-text">Loading momend...</b>
    </div>
    {% csrf_token %}

{% endblock content %}

{% block scripts %}

    <script src="{{ STATIC_URL }}jquery.jplayer.min.js"></script>
    <script src="{{ STATIC_URL }}jquery.transit.min.js"></script>
    <script src="{{ STATIC_URL }}jquery.easing.1.3.js"></script>
    <script src="{{ STATIC_URL }}jquery.animate-shadow.min.js"></script>
    <script src="{{ STATIC_URL }}animation.js"></script>
    <script src="{{ STATIC_URL }}momend.js"></script>
    <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
    <script src='http://connect.facebook.net/en_US/all.js'></script>


    <script type="text/javascript">
        var momendManager;
        var shareOpen = false, tooltipFocused = false;
        function fetchMomendData(){
            $.getJSON( '{% url 'momends:get-momend' params.type params.id %}', function(data) {
                momendManager.momendArrived(data);

            }).error(function(){momendManager.loadFailed();});
        }

        function sendInteractionData(){
            momendManager.sendUserInteractionToServer('{% url 'momends:save-interaction' params.id %}', sendInteractionCallback);
            var sendText = $('#send-interaction-text');
            var sendIcon = $('#send-interaction-icon');
            sendText.text('Sending..');
            sendIcon.removeClass('icon-magic');
            sendIcon.addClass('icon-spin');
            sendIcon.addClass('icon-spinner')
        }

        function sendInteractionCallback(success, msg){
            var sendButton = $('#send-interaction-button');
            var sendText = $('#send-interaction-text');
            var sendIcon = $('#send-interaction-icon');
            if(success){
                sendText.text('Play Interaction');
                sendButton.unbind('click').click(function(){
                    var page_redirect_function = momendManager.getRedirectFunction();
                    if(page_redirect_function){
                        page_redirect_function(msg); //Redirect to returned url to view the interaction
                    }else{
                        window.location.replace(msg);
                    }
                });
                sendIcon.addClass('icon-ok-sign');
            }else{
                sendButton.text(msg);
                sendIcon.addClass('icon-exclamation-sign');
            }
            sendIcon.removeClass('icon-spin');
            sendIcon.removeClass('icon-spinner');

        }
        function playerInit(){
            momendManager = new Momend();
            momendManager.init();
            fetchMomendData();
            if ( window.self === window.top ) {
                $('#scene').addClass('fullscreen'); //Not in iframe
            }
            $('#volume-slider').slider({
                min : 0,
                max : 100,
                value : 100,
                slide : function(event, obj){
                    momendManager.jsAnimate.volumeSliderChanged(obj.value)
                }
            });
            var pauseButton = $('#play-toggle');
            pauseButton.bind('click', momendManager.jsAnimate.pause);

            prepareButtons();
        }
        FB.init({appId: "125999474230740", status: true, cookie: true});

        function postToFacebookFeed() {

            // calling the API ...
            var obj = {
                method: 'feed',
                redirect_uri: 'http://dev.momends.com{% url 'momends:show-momend' params.type params.id %}',
                link: 'http://dev.momends.com{% url 'momends:show-momend' params.type params.id %}',
                picture: 'http://dev.momends.com{{ STATIC_URL }}{{ momend.thumbnail }}',
                name: '{{ momend.name }}',
                caption: 'Did you see this momend',
                description: 'Someone created this momend to show you how wonderful his life is' //TODO momend description here
            };

            function callback(response) {
                console.log("Post ID: " + response['post_id']);
            }

            FB.ui(obj, callback);
        }

        function generateTwitterShareURL(){
            var baseURL ='https://twitter.com/share?';
            var URL = baseURL + 'url='+encodeURIComponent('http://dev.momends.com{% url 'momends:show-momend' params.type params.id %}');
            URL += '&text='+encodeURIComponent('Have you seen this momend?');
            return URL;
        }

        function prepareButtons(){
            var share_button = $('#button-share');
            var fullscreen_button = $('#button-fullscreen');
            var like_button = $('#button-like');
            generateTooltip(share_button,'Share', 'share');
            generateTooltip(fullscreen_button, 'Fullscreen', 'fullscreen');
            generateTooltip(like_button, 'Like', 'like');
            generateWonderfulShare(share_button, 'share');
        }
        function generateTooltip(item, text, id){ //TODO Comment here!
            item.mouseenter(function(){
                var tooltip = $('#'+id+'-tooltip');
                if(tooltip.is('*')){
                    tooltip.css({ //Location may need to change with fullscreen
                        left:Math.min(item.offset().left + item.outerWidth()/2 -40 , $('.scene').outerWidth()-83),
                        width:80,
                        height:20
                    });
                    tooltip.fadeIn();
                }else{
                    tooltip = jQuery('<div/>',{
                        id : id+'-tooltip',
                        class : 'player-tooltip',
                        text : text,
                        hover : function(){tooltipFocused = true}
                    }).appendTo('.player');
                    tooltip.css({
                        left:Math.min(item.offset().left + item.outerWidth()/2 -40 , $('.scene').outerWidth()-83),
                        width:80,
                        height:20
                    });
                    tooltip.fadeIn();
                }
            });
            item.mouseleave(function(){
                var tooltip = $('#'+id+'-tooltip');
                if(id !== 'share' || !shareOpen){
                    tooltip.fadeOut();
                    tooltipFocused = false;
                }else{
                    setTimeout(function(){ //Close the tooltip if not focused in 300ms
                        if(!tooltipFocused){
                            shareOpen = false;
                            _closeShareDialog(tooltip);
                        }
                    }, 300);
                }
            })
        }
        function generateWonderfulShare(item, id){ //TODO Comment here!
            item.click(function(){
                var tooltip = $('#'+id+'-tooltip');
                if(shareOpen){ //Shrink dialog if its open when user clicked
                    shareOpen = false;
                   tooltip.animate({
                       height:20
                   },{duration:300});
                }else{
                    shareOpen = true;
                    tooltip.animate({
                        height:120
                    },{duration:300});
                    if(!$('#share-buttons').is('*')){ //Share buttons not created yet
                        var _buttonHolder = jQuery('<div/>',{
                            id : 'share-buttons',
                            class : 'share-buttons'
                        }).appendTo(tooltip);
                        jQuery('<hr/>').appendTo(_buttonHolder);
                        var _fb = jQuery('<a/>',{
                            href : 'javascript:postToFacebookFeed()',
                            class : 'share-button icon-facebook'
                        }).appendTo(_buttonHolder);
                        var _tw = jQuery('<a/>',{
                            href : generateTwitterShareURL(),
                            target : '_blank',
                            class : 'share-button icon-twitter'
                        }).appendTo(_buttonHolder);
                    }
                    tooltip.mouseleave(function(){
                        shareOpen = false;
                        _closeShareDialog(tooltip);
                    })
                }

            });
        }
    function _closeShareDialog(tooltip){
        tooltip.animate({
            opacity:0,
            height:20
        },{duration:500, complete:function(){
            tooltip.hide();
            tooltip.css({opacity:1});
        }});
    }
    </script>
{% endblock scripts %}

