{% extends "MainSite.html" %}
{% load url from future %}
{% block include %}
    <link href="{{ STATIC_URL }}css/basicmain_style.css" rel="stylesheet">
    <link href="{{ STATIC_URL }}css/datepicker.css" rel="stylesheet">
    <link href="{{ STATIC_URL }}fonts/PTSans/stylesheet.css" rel="stylesheet">
{% endblock include %},
{% block meta %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
{% if momend %}
    <meta property="og:type" content="article"/>
    <meta property="og:image" content="{{ MOMEND_FILE_URL}}{{ momend.thumbnail}}"/>
    <meta property="og:title" content="{{ momend.name }}"/>
    <meta property="og:description" content="You can now re-experience your precious momends!"/>
{% endif %}
{% endblock meta %}
{% block heading %} {% endblock heading %}

{% block content %}
    <div id="maindiv" class="scene">
        <iframe align="center" id="video" class="video" width="100%" height="100%" src="http://www.youtube.com/embed/dVZpm0okAH8?rel=0" frameborder="0" allowfullscreen></iframe>
        {% if user.is_authenticated %}
            <div class="basic-header" id="header">
                <a class="basic-logout-link" id='basic-logout-link' href="{% url 'auth_logout' %}" title="logout" >Logout</a>
            </div>
        {% endif %}
        <div class="transparent" id="transparent-content">
            <div class="logo-div">
                <h6 class="logo">momen<span style="color: darkred">d</span>s</h6>
            </div>
            <div class="actions">
                {% if not user.is_authenticated %}

                    <a href="javascript:watchVideo()" class="white-link">
                        <img src="{{ STATIC_URL }}img/video-icon.jpg"/>
                        What we do?
                    </a>
                    <b style="font-size: 20px;color: #ffffff; margin: 0 9px 0 9px">|</b> <!-- I had to! (pixel perfection :)) -->
                    <a href="#" class="white-link" onclick='showAuthModal("{% url 'auth_login' %}","Sign in")'>Get yours now!</a>
                {% else %}
                    <a href="#" class="white-link" onclick='showCreateModal()'>Hello {{ user.first_name }}, click to create a momend?</a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="social-networks-basic">
        <p>
            <a class="social-network twitter" target="_blank" href="https://twitter.com/momends">
                <img src="{{ STATIC_URL }}img/tw-small.png">
            </a>
            <a class="social-network facebook" target="_blank" href="https://www.facebook.com/momends" style="margin-left: 10px">
                <img src="{{ STATIC_URL }}img/fb-small.png">
            </a>
        </p>
    </div>
    <!-- Create Modal -->
    <div id="create-modal-mini" class="modal hide in fade" tabindex="-1" role="dialog" aria-labelledby="create-modal" aria-hidden="true" data-backdrop="true">
        <form class="form-horizontal" id="create-form" method="post" action="">{% csrf_token %}
            <div class="modal-body" id="create-modal-body-mini">
                <div>
                    <input type="hidden" name="momend_name" id="id_momend_name">
                    <input type="hidden" name="momend_theme" id="id_momend_theme">
                    <input type="hidden" name="privacy_type" id="id_privacy_type">
                    <div id="main-chooser-box">
                        <div class="create-modal-group-title">
                            <span class="create-modal-group-title bold-title">
                                1
                            </span>
                            <span>
                                What do you want to see in your momend?
                            </span>
                        </div>
                        <div class="main-chooser-content">
                            <div id="provider-content">
                                <div id="create-modal-facebook-row" class="provider-row" onclick="socialToggle('facebook')">
                                    <div class="provider-icon-container">
                                        <div id="facebook-icon" class="provider-icon"></div>
                                    </div>
                                    <div class="provider-row-text">
                                        <span id="create-modal-facebook-text" class="provider-row-text-title">
                                            Facebook
                                        </span>
                                    <div id="create-modal-facebook-subtext" class="provider-row-subtext">
                                        </br>We will collect data from </br>your Facebook account
                                    </div>
                                    </div>
                                </div>
                                <div id="create-modal-twitter-row" class="provider-row" onclick="socialToggle('twitter')">
                                    <div class="provider-icon-container">
                                        <div id="twitter-icon" class="provider-icon"></div>
                                    </div>
                                    <div class="provider-row-text">
                                        <div id="create-modal-twitter-text" class="provider-row-text-title">
                                            Twitter
                                        </div>
                                        <div id="create-modal-twitter-subtext" class="provider-row-subtext">
                                            </br>We won't collect data from </br>your Twitter account
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="dropbox-content">
                                <div id="dropbox-inner-content" onclick="Dropbox.choose(dropboxOptions);">
                                    <div id="dropbox-text">
                                        Or you can</br>select photos</br>from your
                                    </div>
                                    <img src="{{ STATIC_URL }}img/dropbox.png" id="dropbox-img">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-seperator" style="background:url('{{ STATIC_URL }}img/seperator.png')"></div>
                    <div id="interval-chooser">
                        <div class="create-modal-group-title">
                            <span class="create-modal-group-title bold-title">
                                2
                            </span>
                            <span>
                                Select time interval for your momend
                            </span>
                        </div>
                        <div class="interval-selectors">
                            <div class="interval-container active" id='interval-all' onclick="dateSelected('all')">
                                ALL</br>DATA
                            </div>
                            <div class="interval-container" id='interval-year' onclick="dateSelected('year')">
                                LAST</br>YEAR
                            </div>
                            <div class="interval-container long" id='interval-custom' onclick="dateSelected('custom')">
                                CUSTOM</br>INTERVAL
                            </div>
                        </div>
                        <div id="date-selector-group">
                            <div class="interval-date-selector" id="date-selector-start">
                                <div class="date-selector-description" >
                                    start
                                </div>
                                <div class="date-selector-text" id="date-selector-start-text"></div>
                                <img src="{{ STATIC_URL }}img/downarrow.png">
                            </div>
                            <div class="interval-date-selector" id="date-selector-end">
                                <div class="date-selector-description">
                                    end
                                </div>
                                <div class="date-selector-text" id="date-selector-end-text"></div>
                                <img src="{{ STATIC_URL }}img/downarrow.png">
                            </div>
                        </div>
                    </div>
                    <div class="modal-seperator" style="background:url('{{ STATIC_URL }}img/seperator.png')"></div>
                    <div id="friend-chooser">
                        <div class="create-modal-group-title">
                            <span class="create-modal-group-title bold-title">
                                3
                            </span>
                            <span>
                                Filter for a friend (optional)
                            </span>
                        </div>
                        <div class="friend-content">
                            <input id="with-box" type="text" name="with-box">
                            <div class="friend-photo pull-right" id="friend-photo-container">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="selected-content-holder">
                    <div id="selected-top" class="create-modal-group-title">
                        <a href="#" id="selected-back-button" onclick="hideSelected()">Back</a>
                        <div id="selected-text">You Selected These Photos</div>
                        <div id="selected-content"></div>
                        <div id="add-more" onclick="Dropbox.choose(dropboxOptions);">Add More?</div>
                    </div>
                </div>
                <div id="get-button">Create Now!</div>
            </div>
        </form>
    </div>
    <div class="creating-dialog-bg" id="creating-dialog-bg">
        <div class="creating-dialog" id="creating-dialog">
            <h3 id="collecting-text">We are creating your momend</h3>
            <img class="collect-box" src="{{ STATIC_URL }}img/box.png">
            <span id="arrow-1" style="background: url('{{ STATIC_URL }}img/arrows.png') -23px 0;width: 150px;
                    height: 110px;left: 40px;position: absolute;opacity: 0.99"></span>
            <span id="arrow-2" style="background: url('{{ STATIC_URL }}img/arrows.png') 190px 20px;width: 150px;
                    height: 110px;right: 40px;position: absolute; opacity: 0.66"></span>
            <span id="arrow-3" style="background: url('{{ STATIC_URL }}img/arrows.png') -5px 110px;width: 150px;
                    height: 110px;left: 40px;top: 270px;position: absolute; opacity: 0.33"></span>
            <span id="arrow-4" style="background: url('{{ STATIC_URL }}img/arrows.png') 140px 140px;width: 150px;
                    height: 110px;right: 40px;top:270px;position: absolute;opacity: 0"></span>
            <h3 style="position: absolute;bottom: -2px">This may take a couple of minutes, and we will also send it via email (to {{ user.email }}) when it is ready!</h3>
        </div>
    </div>
    <div class="basic-dialog" id="welcome-dialog" style="height: 130px">
        <div>
            It seems you don't have any momend yet, here comes your first! </br>(your last 3 years)
        </div>
        <button class="button orange basic-dialog-close" id="close-button" onclick="$('#welcome-dialog').fadeOut()">OK!</button>
    </div>
    <script src="{{ STATIC_URL }}js/bootstrap.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/hogan-2.0.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/typeahead.min.js"></script>
    <script type="text/javascript" src="https://www.dropbox.com/static/api/1/dropins.js" id="dropboxjs" data-app-key="dgmiy8tg8n6m6ku"></script>
    <script>
        var HOST_URL = '{{ HOST_URL }}';
        var currentBg = 0;
        var lastLoaded = -1;
        var bgArr = [];
        var bgDivArr = [];
        var animationInterval = 5000;
        var auth = [{% for provider in providers %}'{{ provider }}',{% endfor %}];
        var _type = '{{ params.type }}';
        var _cid = '{{ params.id }}';
        var user_momend_count = {% if user.is_authenticated %} {{ user_top_momends|length }};{% else %}false;{% endif %}
        var _dialogId = 0;
        var home = '{{ home }}';
        var animationId;
        var momendPlaying = false;
        var createState;
        var selectedFriends;
        var selectedData = {};
        var createModalMaximized = false;
        var logger;
        var selectionMode = false;
        var validPhotoExtensions = ['png', 'jpg', 'jpeg'];

        window.onpopstate = function(e){ //Play momend if the url bar changed after create and user coming back from history
            if(e.state){
                playMomend(e.state.cid, e.state.type === 'i');
            }
        };

        $('body').ready(function(){
            logger = MomendsLogger;
            logger.init('{{ user.username }}', {'page': 'main'});
            for(var i=0;i<5;i++){
                bgArr.push(STATIC_URL+'img/carousel'+(i+1)+'.jpg');
            }
            for (var i = bgArr.length - 1; i > 0; i--) { //Shuffle bg
                var j = Math.floor(Math.random() * (i + 1));
                var temp = bgArr[i];
                bgArr[i] = bgArr[j];
                bgArr[j] = temp;
            }
            loadNext();
            $('.interval-date-selector').each(function(){
                $(this).click(function(){
                    if($(this).data('pickerVisible')){
                        $(this).datepicker('remove');
                        $(this).data('pickerVisible', false);
                    }else{
                        $(this).datepicker({
                            endDate: new Date(),
                            format: "d M, yyyy",
                        }).on('changeDate', function(ev){
                            $(this).datepicker('remove');
                            $('#' + this.id + '-text').text(formatDate("d M, yy", ev.date));
                        });
                        $(this).data('pickerVisible', true);
                    }
                });
            })  
            prepareTypeahead();
            prepareDropbox();
            $('#get-button').click(function(event){
                event.preventDefault();
                var startDate, endDate;
                if($('#interval-all').hasClass('active')){
                    var date = new Date();
                    endDate = formatDate("d M, yy", date);
                    startDate = formatDate("d M, yy", new Date(1970, 1, 1, 0, 0, 0, 0));
                }else if($('#interval-year').hasClass('active')){
                    var date = new Date();
                    endDate = formatDate("d M, yy", date);
                    date.setDate(date.getDate() - (365 * 1) );
                    startDate = formatDate("d M, yy", date);
                }else{
                    endDate = $('#date-selector-end-text').text();
                    startDate = $('#date-selector-start-text').text();
                }

                var twitterActive = $($('#create-modal-twitter-row').children()[0]).hasClass('active');
                var facebookActive = $($('#create-modal-facebook-row').children()[0]).hasClass('active');
                if(!selectionMode){
                    if(!twitterActive && !facebookActive){
                        _showToast('Please select at least one data source (Facebook, Twitter or Dropbox)');
                        return;
                    }
                }else{
                    if(selectedData['dropbox']['photo'].length < 10 ){
                        _showToast('Please select at least 10 photos');
                        return;
                    }
                }
                var postData = {'momend_name': null,
                    'start_date': startDate,
                    'finish_date': endDate,
                    'momend_theme': 0,
                    'privacy_type': 1,
                    'facebook-active': facebookActive,
                    'twitter-active': twitterActive,
                    'friends': function(){
                        var selectedIds = [];
                        for(var i=0; i < selectedFriends.length; i++){
                            selectedIds.push(selectedFriends[i].id);
                        }
                        return selectedIds;
                    },
                    'selected': selectionMode?JSON.stringify(selectedData):null
                };
                createMomend(postData);
                logger.logEvent({'msg': 'Create button pressed', 'create_data': postData});
            });
            if(_cid){ //If we have a video to show
                logger.logEvent({'msg': 'This is actually show page, showing', 'cid': _cid});
                playMomend(_cid, _type === 'i');
            }else if(user_momend_count === 0 && home === 'True'){ //If home page & user logged in and has no momends
                logger.logEvent({'msg': 'Momend count is 0, creating one'});
                welcome();
            }else if(getURLParameter('create') === 'true'){ //Someone told me to show create modal
                logger.logEvent({'msg': 'Parameters told me to show create dialog'});
                showCreateModal();
                _trackPageEvent('Create', 'AutoShowDialog');
            }else if(getURLParameter('login-error') === 'true'){ 
                logger.logEvent({'msg': 'Login error'});
                showAuthModal("{% url 'auth_login' %}","Sign in");
                var showErrorInterval = setInterval(function(){  // Wait until modal loads
                    var orText = $('#connect-or-div');
                    if(orText){
                        $('<div/>',{
                            text: 'Please enter a valid username-password combination',
                            class: 'login-form-error'
                        }).insertAfter(orText);
                        clearInterval(showErrorInterval);
                    }
                },500);
            }else if(getURLParameter('registration-error') !== 'null'){ 
                var error = getURLParameter('registration-error');
                logger.logEvent({'msg': 'Registration Error', 'error': error});
                showAuthModal("{% url 'registration_register' %}","Sign up");
                var showErrorInterval = setInterval(function(){  // Wait until modal loads
                    var content = $('.authenticate-content');
                    if(content){
                        $('<div/>',{
                            text: error,
                            class: 'login-form-error'
                        }).insertBefore(content);
                        clearInterval(showErrorInterval);
                    }
                },500);
            }

        });

        /**
         * Welcomes and creates the first momend for the user
         */
        function welcome(){
            _trackPageEvent('Page', 'Welcome');
            var date = new Date();
            date.setDate(date.getDate() - (365 * 3) );
            var postData = {'momend_name':null,
                'start_date': formatDate("d M, yy", date),
                'finish_date': formatDate("d M, yy", new Date()), //Today
                'momend_theme': 0,
                'privacy_type': 1,
                'facebook-active': true,
                'twitter-active': false,
                'friends': null,
                'selected': null
            };
            createMomend(postData);
            $('#creating-dialog-bg').addClass('dark');
            $('#welcome-dialog').show();
        }

        function createMomend(postData){
            logger.logEvent({'msg': 'Creating screen shown'});
            _trackPageEvent('Create', 'Creating');
            var creatingDialogBg = $('#creating-dialog-bg');
            creatingDialogBg.fadeIn();
            createState = 'We are creating your momend';
            animateCollectingText();
            animateArrows();

            var token = $('[name="csrfmiddlewaretoken"]')[0].value;
            $.ajax({
                type: 'POST',
                timeout: 10*60*1000,
                url: '{% url 'momends:create-momend'%}',
                beforeSend: function(xhr){xhr.setRequestHeader('X-CSRFToken', token);},
                data: postData,
                success: function(msg){
                    var result = JSON.parse(msg);
                    if(result.resp){ //Create requested successfully 
                        setTimeout(function() {checkMomendStatus(result.cid)}, 5000);
                    }else{
                        _trackPageEvent('Momend', 'CreateFailed');
                        logger.logEvent({'msg': 'Create failed with response', 'response': result.message});
                        creatingDialogBg.fadeOut();
                        _showToast(result.message);
                    }
                },
                error: function(msg){
                    _trackPageEvent('Momend', 'CreateServerError');
                    logger.logEvent({'msg': 'Create failed with server error'});
                    creatingDialogBg.fadeOut();
                    _showToast('An error occurred! Please try again later.');
                }
            });
        }

        function checkMomendStatus(crypticId){
            var mainURL = '{% url 'momends:momend-status' 'dummy' %}';
            var statusURL = mainURL.replace('dummy', crypticId);
            var creatingDialogBg = $('#creating-dialog-bg');
            $.getJSON( statusURL, function(data) {
                if(!data.resp){ //Status check request unsuccessful
                    _showToast(data.message);
                }else{
                    if(data.status === 'Success'){
                        creatingDialogBg.fadeOut();
                        $('#create-modal-mini').modal("hide");
                        try{
                            window.history.pushState({'type':'m','cid':result.cid},"", HOST_URL+'/show/m/'+result.cid);
                        }catch(e){
                            //console.log('Different domain?');
                        }
                        logger.logEvent({'msg': 'Created, showing momend'});
                        playMomend(crypticId);
                    }
                    else if(data.status === 'Error'){
                        var message;
                        if(data.message){
                            message = data.message;
                        }else{
                            message = 'An error occurred! Please try again later.';
                        }
                        creatingDialogBg.fadeOut();
                        _showToast(message);
                    }else{
                        createState = data.status;
                        logger.logEvent({'msg': 'Momend status learned', 'status': data.status});
                        setTimeout(function() {checkMomendStatus(crypticId)}, 5000);
                    }
                }

            }).error(function(){
                _showToast('An error occurred! Please try again later.');
                creatingDialogBg.fadeOut();
            });
        }

        /**
         * Loads next background image if not all images are loaded.
         * If current loaded image is the first one shows it, hides the div otherwise
         */
        function loadNext(){
            if(lastLoaded == bgArr.length-1){
                return;
            }
            var bgContainer = jQuery('<div/>',{
                id : 'bg-container'+(lastLoaded+1),
                class : 'scene-background'
            }).appendTo('#maindiv');
            bgDivArr.push(bgContainer);
            var bgImg = jQuery('<img/>',{
                id : 'bg-img'+(lastLoaded+1),
                class : 'background-image',
                src : bgArr[lastLoaded+1]
            }).appendTo(bgContainer);
            bgImg.ready(function(){
                lastLoaded++;
                loadNext();
                if(lastLoaded>0){
                    bgContainer.hide();
                }else{
                    nextAnimation();
                }
            });
        }

        /**
         * Handles fadein - fadeout animations of background images
         */
        function nextAnimation(){
            if(momendPlaying){ //Do not animate if player is active
                return;
            }
            if(lastLoaded != bgDivArr.length-1 && lastLoaded < currentBg+1){ //next item not loaded yet
                setTimeout(nextAnimation, animationInterval);
                return;
            }
            var cur = currentBg;
            currentBg = cur + 1;
            if(currentBg == bgDivArr.length){
                currentBg = 0;
            }
            var appear = bgDivArr[currentBg];
            appear.css({'opacity':0});
            appear.show();
            appear.animate({
                opacity:1
            },{duration:1500,complete:function(){
                setTimeout(nextAnimation, animationInterval);
            }});
            var disappear = bgDivArr[cur];
            disappear.animate({
                opacity:0
            },{duration:1500,complete:function(){
                $(this).hide();
            }});
        }

        /**
         * shows the video and adds a backdrop
         */
        function watchVideo(){
            logger.logEvent({'msg': 'User pressed watch video'});
            _trackPageEvent('Video', 'Watch');
            var box = $("<div/>").addClass("darkCover").click(function(){
                $(this).fadeOut();
                content.fadeOut();
                document.getElementById('video').src="http://www.youtube.com/embed/dVZpm0okAH8?rel=0";

            });
            $("body").prepend(box);

            box.fadeTo("fast",0.8);
            var content = $('#video');
            content.fadeIn(1000);
            $("body").prepend(content);
            content.fadeTo("fast",1);
        }

        function showCreateModal(){
            _trackPageEvent('Create', 'ShowDialog');
            logger.logEvent({'msg': 'Create modal shown'});
            var modal = $('#create-modal-mini');
            modal.css('margin-left',modal.outerWidth()/-2);
            modal.modal();
            for(var i = 0;i<auth.length; i++){ //Mark authenticated providers as active
                socialToggle(auth[i], true);
            }
            var startDate = $('#date-selector-start-text');
            var endDate = $('#date-selector-end-text');
            if(startDate.text().length == 0){
                var date = new Date();
                endDate.text(formatDate("d M, yy", date));
                date.setDate(date.getDate() -365 ); //Go back 1 year fo start date
                startDate.text(formatDate("d M, yy", date));
            }
        }

        function prepareTypeahead(){
            var withBox = $('#with-box');
            withBox.val('Loading friend lists...');
            $.getJSON('{% url 'momends:user-friends' %}', function(data){
                if(data.resp){
                    for(var i=0; i<data.list.length; i++){
                        var _providerName = data.list[i].name;
                        for(var j=0; j< data.list[i].local.length; j++){
                            var _name =  data.list[i].local[j]['name'];
                            data.list[i].local[j].tokens = _name.split(' ');
                            data.list[i].local[j].id = _providerName + '-' + data.list[i].local[j].id;  // To format like facebook-123456
                            if(_providerName === 'facebook'){
                                data.list[i].local[j].value = _name;
                            }else if(_providerName === 'twitter'){
                                var _screenName = data.list[i].local[j].screen_name;
                                data.list[i].local[j].value = _name +' - '+_screenName;
                                data.list[i].local[j].tokens.push(_screenName);
                            }
                        }
                        data.list[i].template =  '<p><i class="icon-'+_providerName+'" style="margin-right:5px"></i>{% templatetag openvariable %}value{% templatetag closevariable %}</strong><span class="tt-suggested-id">'+_providerName+'-{% templatetag openvariable %}id{% templatetag closevariable %}</span></p>';
                        data.list[i].engine = Hogan;
                    }
                    withBox.val('');
                    withBox.typeahead(data.list);
                    logger.logEvent({'msg': 'typeahead initialized'});
                }
            });
            withBox.on('typeahead:selected', friendSelected);
            withBox.bind('change', friendBoxChanged);
            selectedFriends = [];
        }
        function friendSelected($e){
            if(arguments.length == 2){
                var photoContainer = $('#friend-photo-container');
                var selected = arguments[1];
                if($.inArray(selected, selectedFriends) === -1){

                    if(selectedFriends.length > 0){  // We currently allow only 1 friend
                        selectedFriends.pop();
                        photoContainer.children().remove();
                        logger.logEvent({'msg': 'previously selected friend popped out'});
                    }

                    selectedFriends.push(selected);
                    logger.logEvent({'msg': 'selected a friend from typeahead', 'friend': selected});
                    var parts = selected.id.split('-');
                    if(parts[0] === 'facebook'){
                        jQuery('<img/>',{
                            src: 'http://graph.facebook.com/' + parts[1] + '/picture?type=square'
                        }).appendTo(photoContainer);
                        photoContainer.animate({'opacity': 1}, 200);
                    }
                }
            }
        }

        function friendBoxChanged(event){
            var photoContainer = $('#friend-photo-container');
            if(selectedFriends.length > 0){
                selectedFriends.pop();
                photoContainer.children().remove();
                photoContainer.animate({'opacity': 0}, 200);
                logger.logEvent({'msg': 'Friend selection cleared'});
            }
        }

        function prepareDropbox(){
            selectedData['dropbox'] = {'photo': []};
            dropboxOptions = {
                linkType: "direct",
                multiselect: true,
                success: function(files) {
                    links = [];
                    for(var i = 0; i < files.length; i++){
                        var extension = files[i].link.substring(files[i].link.lastIndexOf('.') + 1);
                        if(validPhotoExtensions.indexOf(extension) < 0){
                            continue;
                        }
                        tmp = {'link': files[i].link, 'thumbnail': files[i]['thumbnails']['64x64']}
                        links.push(tmp);
                    }
                    showSelectedContentsModal();
                    selectedData['dropbox']['photo'] = selectedData['dropbox']['photo'].concat(links);
                    updateSelectedContents();
                    },
                cancel:  function() {
                    }
            };
        }

        function showSelectedContentsModal(){
            var contentHolder = $('#selected-content-holder');
            var modal = $('#create-modal-mini');
            contentHolder.show();
            selectionMode = true;
            logger.logEvent({'msg': 'showing selected data modal'});
        }
        function hideSelected(){
            selectedData['dropbox'] = {'photo': []};
            var contentHolder = $('#selected-content-holder');
            contentHolder.hide();
            selectionMode = false;
            logger.logEvent({'msg': 'hiding selected data modal'});
        }

        /**
        Updates the selected data list with the new data set (global)selectedData
        */
        function updateSelectedContents(){
            $('.selected-list').remove();
            var list = jQuery('<ul/>',{
                class: 'selected-list'
            }).appendTo('#selected-content');
            for(var provider in selectedData){
                $.each(selectedData[provider]['photo'], function(index, photoObj){
                        if(typeof photoObj !== 'undefined'){
                        var li = jQuery('<li/>',{
                            id: 'selected-' + provider + '-' + index
                        }).appendTo(list);
                        var thumbLink = jQuery('<a/>',{
                            class: 'selected-content-thumb-link',
                            href: photoObj['link'],
                            target: '_blank'
                        }).appendTo(li);
                        jQuery('<img/>',{
                            src: photoObj['thumbnail'],
                            class: 'selected-content-thumb'
                        }).appendTo(thumbLink);
                        if(provider === 'dropbox'){
                            var name = decodeURIComponent(photoObj['link'].substring(photoObj['link'].lastIndexOf('/') + 1));
                            jQuery('<span/>',{
                                text: name,
                                class: 'selected-content-text'
                            }).appendTo(li);
                            jQuery('<a/>',{
                                class: 'close selected-remove',
                                href: '#',
                                text: 'x',
                                click: function(){
                                    delete selectedData[provider]['photo'][index];
                                    li.remove();
                                    //updateSelectedContents();  // In case something goes wrong, this is a brutal but solid solution
                                }
                            }).appendTo(li);
                        }
                    }
                });
            }
        }

        function animateCollectingText(state){
            if(!state || state === 4){
                state = 0;
            }
            var obj = $('#collecting-text');
            var width = (createState.length+3)*9;
            var container = $('#creating-dialog');
            obj.css({'left': (container.outerWidth() - width) / 2});
            var tmpText = createState;
            for (var i=0;i<state;i++){
                tmpText += '.';
            }
            obj.text(tmpText);
            setTimeout(function(){
                animateCollectingText(state+1);
            },500);
        }
        function animateArrows(){
            var arrowAnimationIntervalId = setInterval(function(){
                for(var i = 1; i<5; i++){
                    var _arrow = $('#arrow-'+i);
                    var _arrowOpacity = _arrow.css('opacity');
                    _arrowOpacity -= 0.34;
                    if(_arrowOpacity<0){
                        _arrowOpacity = 0.99;
                    }
                    _arrow.animate({'opacity':_arrowOpacity},400);
                }
            },500);
        }

        function showAuthModal(_url, title){
            _trackPageEvent('Auth', 'ShowDialog');
            logger.logEvent({'msg': 'Auth dialog shown'});

            var modal =jQuery('<div/>',{
                'id': 'modal',
                'class' : 'modal hide fade',
                'tabindex' : '-1',
                'role' : 'dialog',
                'aria-labelledby' : 'modal-label',
                'aria-hidden' : 'true'
            }).appendTo('body');
            var header = jQuery('<div/>',{
                'class' : 'modal-header'
            }).appendTo(modal);
            jQuery('<h3/>',{
                'text' : title
            }).appendTo(header);
            var modal_body = jQuery('<div/>',{
                class : 'modal-body'
            }).appendTo(modal);
            modal.ready(function(){
                modal.modal({
                    'remote' : _url
                });
            });
            modal.bind('hidden',function(){
                $(this).remove();
            });
        }
        function socialToggle(provider, forceTo){
            if($.inArray(provider, auth) >= 0){
                var row = $('#create-modal-'+provider+'-row');
                var rowsChildren = row.children();
                var iconBorder = $(rowsChildren[0]);
                var icon = $('#' + provider + '-icon');
                var text = $('#create-modal-' + provider + '-text');
                var subtext = $('#create-modal-' + provider + '-subtext');
                var providerCapitalizedName = provider.charAt(0).toUpperCase() + provider.slice(1);
                if(forceTo !== true && (forceTo === false || $(rowsChildren[0]).hasClass('active'))){
                    logger.logEvent({'msg': 'social toggle off', 'provider_name': provider, 'forcedTo': forceTo});
                    iconBorder.removeClass('active');
                    icon.removeClass('active');
                    text.removeClass('active');
                    text.text(providerCapitalizedName + ' Off');
                    subtext.text('We won\'t collect data from your ' + providerCapitalizedName + ' account');
                }else{
                    logger.logEvent({'msg': 'social toggle on', 'provider_name': provider, 'forcedTo': forceTo});
                    iconBorder.addClass('active');
                    icon.addClass('active');
                    text.addClass('active');
                    text.text(providerCapitalizedName + ' On');
                    subtext.text('We will collect data from your ' + providerCapitalizedName + ' account');
                }
            }else{ //Show authentication dialog
                logger.logEvent({'msg': 'Social toggle sign-in dialog shown', 'provider_name': provider});
                var connectURL = HOST_URL + '{% url 'socialauth_begin' 'provider_name' %}';
                connectURL = connectURL.replace('provider_name', provider);
                window.location.replace(connectURL);
            }
        }
        function dateSelected(type){
            logger.logEvent({'msg': 'date select button pressed', 'type': type});
            $('.interval-container').each(function(){
                $(this).removeClass('active');
            });
            $('#interval-'+type).addClass('active');
            switch(type){
                case 'custom':
                    $('#date-selector-group').animate({'opacity':1}, 200);
                    break;
                default:
                    $('#date-selector-group').animate({'opacity':0}, 200);
                    break;
            }
        }

    function _animateCreateModal(modalSize, bodySize, duration){
        var modal = $('#create-modal-mini');
        var body = $('#create-modal-body-mini')
        modal.animate({height:modalSize}, duration);
        body.animate({height:bodySize}, duration)
    }
    function playMomend(cid, isInteraction){
        momendPlaying = true;
        var mainURL = '{% url 'momends:play-momend' 'm' 'dummy' %}';
        var momendURL = mainURL.replace('dummy', cid);
        if(isInteraction === true){
            momendURL = momendURL.replace('/m/','/i/'); //TODO better?
        }
        var playBG = jQuery('<div/>',{
            id : 'play-bg',
            class : 'play-bg'
        }).appendTo('body');
        var portablePlayer = jQuery('<div/>',{
            id : 'momend-player',
            class: 'portable-player regular'
        }).appendTo(playBG);
        var playerFrame = jQuery('<iframe/>',{
            src : momendURL,
            style : 'width: 100%;height: 100%;border: 0;',
            id : 'momend-player-frame',
            onload : 'frameLoaded()'
        }).appendTo(portablePlayer);
        logger.logEvent({'msg': 'Player shown'});
        playBG.click(function(){ //Pause the momend and minimize it if backdrop pressed
            logger.logEvent({'msg': 'momend minimized'});
            momendManager.jsAnimate.pause();
            $('#momend-player').animate({'width':0,'height':0,'top':0,'left':'35%'},500);
            setTimeout(function(){
                playBG.fadeOut(function(){
                    momendPlaying = false;
                    nextAnimation();
                });
            },300);
            if(!$('#show-again').is('*')){ //To prevent inserting more than 1 buttons if user presses the button repeatedly
                if(!$('#header').is('*')){
                    jQuery('<div/>',{
                        class : 'basic-header',
                        id : 'header'
                    }).appendTo('#maindiv');
                }
                var showAgainButton = jQuery('<a/>',{
                    text : 'Show momend',
                    class : 'basic-show-again-link',
                    id :'show-again',
                    href : '#'
                }).appendTo('#header');
                $('#basic-logout-link').css({float:'right'}); // to send Logout to the right most side again
                showAgainButton.click(function(event){
                    logger.logEvent({'msg': 'momend maximized back'});
                    momendPlaying = true;
                    event.preventDefault();
                    playBG.fadeIn();
                    setTimeout(function(){
                        $('#momend-player').animate({'width':640,'height':480,'top':'20%','left':0},300);
                    },300);
                    $(this).remove();
                });
            }
        });
    }
    </script>
    <script>
        /**
         * This group handles momend player frame
         */
        fullscreen_on = false;
        function frameLoaded(){
            logger.logEvent({'msg': 'Player frame loaded'});
            player_frame = document.getElementById('momend-player-frame');
            momendManager = player_frame.contentWindow.momendManager;
            momendManager.setFullscreenFunction(fullscreen);
            momendManager.addFinishListenerFunction(finished);
            momendManager.setRedirectFunction(redirectToPage);
            //We may want to open in a new tab?
        }
        function finished(){
            logger.logEvent({'msg': 'player finished'});
            if(fullscreen_on){
                fullscreen();
            }
        }
        function fullscreen(){
            momendManager.fullscreenToggle();
            var player = $('#momend-player');
            if(!fullscreen_on){
                player.addClass('fullscreen');
                player.removeClass('regular');
                _trackPageEvent('Fullscreen', 'On');
                logger.logEvent({'msg': 'Fullscreen!!!'});
            }else{
                player.removeClass('fullscreen');
                player.addClass('regular');
                _trackPageEvent('Fullscreen', 'Off');
                logger.logEvent({'msg': 'Fulscreen off!!!'});
            }
            fullscreen_on = !fullscreen_on;
        }
        function redirectToPage(url){
            logger.logEvent({'msg': 'Redirecting to page', 'url': url});
            location.href = url;
        }
        function getURLParameter(name) {
            return decodeURI(
                    (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
            );
        }
    </script>
    <script type="text/javascript">
        /**
        *JQuery UI's datePicker's format date function
        */
        function formatDate(format, date, settings) {
            if (!date) {
                return "";
            }

            var iFormat,
                dayNames= ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                dayNamesShort= ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                monthNames= ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                monthNamesShort= ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
                // Check whether a format character is doubled
                lookAhead = function(match) {
                    var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) === match);
                    if (matches) {
                        iFormat++;
                    }
                    return matches;
                },
                // Format a number, with leading zero if necessary
                formatNumber = function(match, value, len) {
                    var num = "" + value;
                    if (lookAhead(match)) {
                        while (num.length < len) {
                            num = "0" + num;
                        }
                    }
                    return num;
                },
                // Format a name, short or long as requested
                formatName = function(match, value, shortNames, longNames) {
                    return (lookAhead(match) ? longNames[value] : shortNames[value]);
                },
                output = "",
                literal = false;

            if (date) {
                for (iFormat = 0; iFormat < format.length; iFormat++) {
                    if (literal) {
                        if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                            literal = false;
                        } else {
                            output += format.charAt(iFormat);
                        }
                    } else {
                        switch (format.charAt(iFormat)) {
                            case "d":
                                output += formatNumber("d", date.getDate(), 2);
                                break;
                            case "D":
                                output += formatName("D", date.getDay(), dayNamesShort, dayNames);
                                break;
                            case "o":
                                output += formatNumber("o",
                                    Math.round((new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 86400000), 3);
                                break;
                            case "m":
                                output += formatNumber("m", date.getMonth() + 1, 2);
                                break;
                            case "M":
                                output += formatName("M", date.getMonth(), monthNamesShort, monthNames);
                                break;
                            case "y":
                                output += (lookAhead("y") ? date.getFullYear() :
                                    (date.getYear() % 100 < 10 ? "0" : "") + date.getYear() % 100);
                                break;
                            case "@":
                                output += date.getTime();
                                break;
                            case "!":
                                output += date.getTime() * 10000 + this._ticksTo1970;
                                break;
                            case "'":
                                if (lookAhead("'")) {
                                    output += "'";
                                } else {
                                    literal = true;
                                }
                                break;
                            default:
                                output += format.charAt(iFormat);
                        }
                    }
                }
            }
            return output;
        }
    </script>
{% endblock content %}
{% block footer%} {% endblock footer %}



